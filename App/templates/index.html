{% extends "layout.html" %}

{% block title %}Apartments{% endblock %}
{% block page %}Browse Apartments{% endblock %}

{% block styles %}
.collection .collection-item.active {
    background-color: #1565C0;
    color: white;
}
{% endblock %}

{% block content %}

<div class="row">
  <!-- Column 1: Apartment List -->
  <div class="col m4" style="max-height: 80vh; overflow-y: auto;">
    <h5>Apartments</h5>
    <ul class="collection">
      {% for apartment in apartments %}
        <li class="collection-item {% if selected_apartment and apartment.id == selected_apartment.id %}active{% endif %}">
          <a href="{{ url_for('apartment_views.show_apartments', selected=apartment.id) }}" style="color: inherit;">
            {{ apartment.title }} - ${{ apartment.price }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Column 2: Apartment Details + Review -->
  <div class="col m4">
    {% if selected_apartment %}
      <h5>{{ selected_apartment.title }}</h5>
      <p><strong>Price:</strong> ${{ selected_apartment.price }}</p>
      <p><strong>Address:</strong> {{ selected_apartment.address }}, {{ selected_apartment.cityname }}</p>
      <p><strong>Description:</strong> {{ selected_apartment.body }}</p>
      <p><strong>Amenities:</strong> {{ selected_apartment.amenities }}</p>
      <p><strong>Pets Allowed:</strong> {{ selected_apartment.pets_allowed }}</p>
      {% if selected_apartment.photo %}
        <img src="{{ url_for('static', filename='uploads/' ~ selected_apartment.photo) }}" alt="Apartment Image" style="max-width: 100%;">
      {% endif %}

      <h6>Reviews</h6>
      {% if reviews %}
        <ul class="collection">
          {% for review in reviews %}
            <li class="collection-item">
              {{ review.content }} - Rating: {{ review.rating }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No reviews yet.</p>
      {% endif %}

      {% if user_id and user_type == 'tenant' %}
        <h6>Leave a Review</h6>
        <form action="/reviews/{{ selected_apartment.id }}" method="POST">
          <textarea name="content" placeholder="Write your review..." required></textarea>
          <input type="number" name="rating" min="1" max="5" required>
          <button type="submit" class="btn blue">Submit Review</button>
        </form>
      {% endif %}
    {% else %}
      <p>Select an apartment to see more details.</p>
    {% endif %}
{% endwith %}

{% if is_authenticated %}
    <p>Welcome {{ current_user.username }}</p>
{% endif %}

<div class="right-align" style="margin-bottom: 20px;">
    <a href="{{ url_for('apartment_views.new_apartment') }}" class="btn red white-text">+ Add Apartment</a>
</div>

{% for apartment in apartments %}
    <div class="card">
        <div class="card-content">
            <h5>{{ apartment.title }}</h5>
            <p><strong>Description:</strong> {{ apartment.body }}</p>
            <p><strong>Amenities:</strong> {{ apartment.amenities }}</p>
            {% if apartment.photo %}
                <div class="card-image">
                    <img src="{{ url_for('upload_views.uploaded_file', filename=apartment.photo) }}" alt="Apartment Photo">
                </div>
            {% endif %}
            <p><strong>Pets Allowed:</strong> {{ apartment.pets_allowed }}</p>
            <p><strong>Price:</strong> {{ apartment.price }}</p>
            <p><strong>Address:</strong> {{ apartment.address }}</p>
            <p><strong>Location:</strong> {{ apartment.cityname }}</p>

            <!-- Display reviews link -->
            <p>
                <a href="{{ url_for('review_views.view_reviews', apartment_id=apartment.id) }}" class="btn green white-text">
                    View Reviews
                </a>
            </p>
        </div>
        <div class="card-action">
            <a href="{{ url_for('apartment_views.edit_apartment', id=apartment.id) }}" class="btn blue white-text">Edit</a>
            <form method="POST" action="{{ url_for('apartment_views.delete_apartment_route', id=apartment.id) }}" style="display:inline;">
                <button type="submit" class="btn red white-text">Delete</button>
            </form>
        </div>
    </div>
{% endfor %}
{% endblock %}
